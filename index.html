<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <link rel="preload" href="build/qalc.js" as="script">
    <link rel="preload" href="build/qalc.wasm" as="fetch">
</head>


<body style="max-width: 600px; margin-left: auto; margin-right: auto">
    <h1>Qalculate!</h1>

    <p>This page is designed to test running Qalculate in the browser using WASM. At the moment, currencies and units
        are not supported, as those require external resources.</p>

    <div id="status">Downloading...</div>


    <input type="text" id="input" style="width: 100%" placeholder="1+2">
    <div id="result"></div>

    <script type='text/javascript'>
        var statusElement = document.getElementById('status');
        const resultEl = document.getElementById('result');
        document.getElementById('input').oninput = (ev) => {
            const text = ev.target.value;
            const resultPtr = calculate(calc, text, 1000);
            const result = UTF8ToString(resultPtr);
            free(resultPtr);
            resultEl.textContent = result
        }

        var Module = {
            preRun: [],
            postRun: [() => {
                window.calculate = Module.cwrap('calculate', 'number', ['number', 'string', 'number'])
                window.newCalculator = Module.cwrap('newCalculator', 'number', [])
                window.free = Module.cwrap('free', 'void', ['number'])

                console.time('new')
                window.calc = newCalculator()
                console.timeEnd('new')
                console.time('calc x1000')
                for (let i = 0; i < 1000; i++) {
                    calculate(calc, '1+1', 1000)
                }
                console.timeEnd('calc x1000')
            }],
            print: function (text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.log(text);
            },
            printErr: function (text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.error(text);
            },
            setStatus: function (text) {
                if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
                if (text === Module.setStatus.last.text) return;
                var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
                var now = Date.now();
                if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
                Module.setStatus.last.time = now;
                Module.setStatus.last.text = text;
                if (m) {
                    text = m[1];
                }
                statusElement.innerHTML = text;
            },
            totalDependencies: 0,
            monitorRunDependencies: function (left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            }
        };
        Module.setStatus('Downloading...');
        window.onerror = function (event) {
            // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
            Module.setStatus('Exception thrown, see JavaScript console');
            Module.setStatus = function (text) {
                if (text) Module.printErr('[post-exception status] ' + text);
            };
        };
    </script>
    <script async type="text/javascript" src="build/qalc.js"></script>
</body>

</html>